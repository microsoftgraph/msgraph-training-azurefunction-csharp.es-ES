---
ms.openlocfilehash: eb227079656e2a57550511c3abfacb49935fe46a
ms.sourcegitcommit: 141fe5c30dea84029ef61cf82558c35f2a744b65
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 12/11/2020
ms.locfileid: "49655243"
---
<!-- markdownlint-disable MD002 MD041 -->

<span data-ttu-id="dc82c-101">En este ejercicio finalizará la implementación de las funciones de Azure `SetSubscription` y se `Notify` actualizará la aplicación de prueba para suscribirse y cancelar la suscripción a los cambios en la bandeja de entrada de un usuario.</span><span class="sxs-lookup"><span data-stu-id="dc82c-101">In this exercise you will finish implementing the Azure Functions `SetSubscription` and `Notify`, and update the test application to subscribe and unsubscribe to changes in a user's inbox.</span></span>

- <span data-ttu-id="dc82c-102">La `SetSubscription` función actuará como una API, lo que permite que la aplicación de prueba cree o elimine una [suscripción](https://docs.microsoft.com/graph/webhooks) a los cambios en la bandeja de entrada de un usuario.</span><span class="sxs-lookup"><span data-stu-id="dc82c-102">The `SetSubscription` function will act as an API, allowing the test app to create or delete a [subscription](https://docs.microsoft.com/graph/webhooks) to changes in a user's inbox.</span></span>
- <span data-ttu-id="dc82c-103">La `Notify` función actuará como el webhook que recibe las notificaciones de cambios generadas por la suscripción.</span><span class="sxs-lookup"><span data-stu-id="dc82c-103">The `Notify` function will act as the webhook that receives change notifications generated by the subscription.</span></span>

<span data-ttu-id="dc82c-104">Ambas funciones usarán el [flujo de concesión de credenciales de cliente](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow) para obtener un token de solo aplicación para llamar a Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="dc82c-104">Both functions will use the [client credentials grant flow](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow) to get an app-only token to call Microsoft Graph.</span></span> <span data-ttu-id="dc82c-105">Debido a que un administrador concedió el consentimiento del administrador a los ámbitos de permiso necesarios, no se requiere ninguna interacción del usuario para obtener el token.</span><span class="sxs-lookup"><span data-stu-id="dc82c-105">Because an administrator granted admin consent to the required permission scopes, no user interaction will be required to get the token.</span></span>

## <a name="add-client-credentials-authentication-to-the-azure-functions-project"></a><span data-ttu-id="dc82c-106">Agregar autenticación de credenciales de cliente al proyecto de funciones de Azure</span><span class="sxs-lookup"><span data-stu-id="dc82c-106">Add client credentials authentication to the Azure Functions project</span></span>

<span data-ttu-id="dc82c-107">En esta sección, implementará el flujo de credenciales de cliente en el proyecto de funciones de Azure para obtener un token de acceso compatible con Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="dc82c-107">In this section you'll implement the client credentials flow in the Azure Functions project to get an access token compatible with Microsoft Graph.</span></span>

1. <span data-ttu-id="dc82c-108">Abra su CLI en el directorio que contiene **GraphTutorial. csproj**.</span><span class="sxs-lookup"><span data-stu-id="dc82c-108">Open your CLI in the directory that contains **GraphTutorial.csproj**.</span></span>

1. <span data-ttu-id="dc82c-109">Agregue el identificador y el secreto de la aplicación de webhook al almacén secreto mediante los comandos siguientes.</span><span class="sxs-lookup"><span data-stu-id="dc82c-109">Add your webhook application ID and secret to the secret store using the following commands.</span></span> <span data-ttu-id="dc82c-110">Reemplace `YOUR_WEBHOOK_APP_ID_HERE` por el identificador de la aplicación para el **webhook** de la función de Microsoft de Graph.</span><span class="sxs-lookup"><span data-stu-id="dc82c-110">Replace `YOUR_WEBHOOK_APP_ID_HERE` with the application ID for the **Graph Azure Function Webhook**.</span></span> <span data-ttu-id="dc82c-111">Reemplace `YOUR_WEBHOOK_APP_SECRET_HERE` por el secreto de aplicación que ha creado en Azure portal para el **webhook de la función Graph de Azure**.</span><span class="sxs-lookup"><span data-stu-id="dc82c-111">Replace `YOUR_WEBHOOK_APP_SECRET_HERE` with the application secret you created in the Azure portal for the **Graph Azure Function Webhook**.</span></span>

    ```Shell
    dotnet user-secrets set webHookId "YOUR_WEBHOOK_APP_ID_HERE"
    dotnet user-secrets set webHookSecret "YOUR_WEBHOOK_APP_SECRET_HERE"
    ```

### <a name="create-a-client-credentials-authentication-provider"></a><span data-ttu-id="dc82c-112">Crear un proveedor de autenticación de credenciales de cliente</span><span class="sxs-lookup"><span data-stu-id="dc82c-112">Create a client credentials authentication provider</span></span>

1. <span data-ttu-id="dc82c-113">Cree un archivo nuevo en el directorio **./GraphTutorial/Authentication** denominado **ClientCredentialsAuthProvider.CS** y agregue el siguiente código.</span><span class="sxs-lookup"><span data-stu-id="dc82c-113">Create a new file in the **./GraphTutorial/Authentication** directory named **ClientCredentialsAuthProvider.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Authentication/ClientCredentialsAuthProvider.cs" id="AuthProviderSnippet":::

<span data-ttu-id="dc82c-114">Tómese un momento para considerar lo que hace el código en **ClientCredentialsAuthProvider.CS** .</span><span class="sxs-lookup"><span data-stu-id="dc82c-114">Take a moment to consider what the code in **ClientCredentialsAuthProvider.cs** does.</span></span>

- <span data-ttu-id="dc82c-115">En el constructor, Inicializa un **ConfidentialClientApplication** desde el `Microsoft.Identity.Client` paquete.</span><span class="sxs-lookup"><span data-stu-id="dc82c-115">In the constructor, it initializes a **ConfidentialClientApplication** from the `Microsoft.Identity.Client` package.</span></span> <span data-ttu-id="dc82c-116">Usa las `WithAuthority(AadAuthorityAudience.AzureAdMyOrg, true)` funciones y `.WithTenantId(tenantId)` para restringir la audiencia de inicio de sesión a solo la organización de Microsoft 365 especificada.</span><span class="sxs-lookup"><span data-stu-id="dc82c-116">It uses the `WithAuthority(AadAuthorityAudience.AzureAdMyOrg, true)` and `.WithTenantId(tenantId)` functions to restrict the login audience to only the specified Microsoft 365 organization.</span></span>
- <span data-ttu-id="dc82c-117">En la `GetAccessToken` función, llama `AcquireTokenForClient` a para obtener un token para la aplicación.</span><span class="sxs-lookup"><span data-stu-id="dc82c-117">In the `GetAccessToken` function, it calls `AcquireTokenForClient` to get a token for the application.</span></span> <span data-ttu-id="dc82c-118">El flujo de tokens de credenciales de cliente es siempre no interactivo.</span><span class="sxs-lookup"><span data-stu-id="dc82c-118">The client credentials token flow is always non-interactive.</span></span>
- <span data-ttu-id="dc82c-119">Implementa la `Microsoft.Graph.IAuthenticationProvider` interfaz, lo que permite pasar esta clase en el constructor de `GraphServiceClient` para autenticar las solicitudes salientes.</span><span class="sxs-lookup"><span data-stu-id="dc82c-119">It implements the `Microsoft.Graph.IAuthenticationProvider` interface, allowing this class to be passed in the constructor of the `GraphServiceClient` to authenticate outgoing requests.</span></span>

## <a name="update-graphclientservice"></a><span data-ttu-id="dc82c-120">Actualizar GraphClientService</span><span class="sxs-lookup"><span data-stu-id="dc82c-120">Update GraphClientService</span></span>

1. <span data-ttu-id="dc82c-121">Abra **GraphClientService.CS** y agregue la siguiente propiedad a la clase.</span><span class="sxs-lookup"><span data-stu-id="dc82c-121">Open **GraphClientService.cs** and add the following property to the class.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Services/GraphClientService.cs" id="AppGraphClientMembers":::

1. <span data-ttu-id="dc82c-122">Reemplace la función `GetAppGraphClient` existente por lo siguiente.</span><span class="sxs-lookup"><span data-stu-id="dc82c-122">Replace the existing `GetAppGraphClient` function with the following.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Services/GraphClientService.cs" id="AppGraphClientFunctions":::

## <a name="implement-notify-function"></a><span data-ttu-id="dc82c-123">Función de implementación de notificación</span><span class="sxs-lookup"><span data-stu-id="dc82c-123">Implement Notify function</span></span>

<span data-ttu-id="dc82c-124">En esta sección, implementará la `Notify` función, que se utilizará como dirección URL de notificación para las notificaciones de cambios.</span><span class="sxs-lookup"><span data-stu-id="dc82c-124">In this section you'll implement the `Notify` function, which will be used as the notification URL for change notifications.</span></span>

1. <span data-ttu-id="dc82c-125">Cree un nuevo directorio en el directorio **GraphTutorials** denominado **Models**.</span><span class="sxs-lookup"><span data-stu-id="dc82c-125">Create a new directory in the **GraphTutorials** directory named **Models**.</span></span>

1. <span data-ttu-id="dc82c-126">Cree un nuevo archivo en el directorio **modelos** denominado **ResourceData.CS** y agregue el siguiente código.</span><span class="sxs-lookup"><span data-stu-id="dc82c-126">Create a new file in the **Models** directory named **ResourceData.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Models/ResourceData.cs" id="ResourceDataSnippet":::

1. <span data-ttu-id="dc82c-127">Cree un nuevo archivo en el directorio **modelos** denominado **ChangeNotification.CS** y agregue el siguiente código.</span><span class="sxs-lookup"><span data-stu-id="dc82c-127">Create a new file in the **Models** directory named **ChangeNotification.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Models/ChangeNotification.cs" id="ChangeNotificationSnippet":::

1. <span data-ttu-id="dc82c-128">Cree un nuevo archivo en el directorio **modelos** denominado **NotificationList.CS** y agregue el siguiente código.</span><span class="sxs-lookup"><span data-stu-id="dc82c-128">Create a new file in the **Models** directory named **NotificationList.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Models/NotificationList.cs" id="NotificationListSnippet":::

1. <span data-ttu-id="dc82c-129">Abra **./GraphTutorial/Notify.CS** y reemplace todo el contenido por lo siguiente.</span><span class="sxs-lookup"><span data-stu-id="dc82c-129">Open **./GraphTutorial/Notify.cs** and replace its entire contents with the following.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Notify.cs" id="NotifySnippet":::

<span data-ttu-id="dc82c-130">Tómese un momento para considerar lo que hace el código en **Notify.CS** .</span><span class="sxs-lookup"><span data-stu-id="dc82c-130">Take a moment to consider what the code in **Notify.cs** does.</span></span>

- <span data-ttu-id="dc82c-131">La `Run` función comprueba la presencia de un `validationToken` parámetro de consulta.</span><span class="sxs-lookup"><span data-stu-id="dc82c-131">The `Run` function checks for the presence of a `validationToken` query parameter.</span></span> <span data-ttu-id="dc82c-132">Si ese parámetro está presente, procesa la solicitud como una [solicitud de validación](https://docs.microsoft.com/graph/webhooks#notification-endpoint-validation)y responde en consecuencia.</span><span class="sxs-lookup"><span data-stu-id="dc82c-132">If that parameter is present, it processes the request as a [validation request](https://docs.microsoft.com/graph/webhooks#notification-endpoint-validation), and responds accordingly.</span></span>
- <span data-ttu-id="dc82c-133">Si la solicitud no es una solicitud de validación, la carga JSON se deserializa en un `NotificationList` .</span><span class="sxs-lookup"><span data-stu-id="dc82c-133">If the request is not a validation request, the JSON payload is deserialized into a `NotificationList`.</span></span>
- <span data-ttu-id="dc82c-134">Cada notificación de la lista se comprueba para el valor de estado de cliente esperado y se procesa.</span><span class="sxs-lookup"><span data-stu-id="dc82c-134">Each notification in the list is checked for the expected client state value, and is processed.</span></span>
- <span data-ttu-id="dc82c-135">El mensaje que desencadenó la notificación se recupera con Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="dc82c-135">The message that triggered the notification is retrieved with Microsoft Graph.</span></span>

## <a name="implement-setsubscription-function"></a><span data-ttu-id="dc82c-136">Implementar la función SetSubscription</span><span class="sxs-lookup"><span data-stu-id="dc82c-136">Implement SetSubscription function</span></span>

<span data-ttu-id="dc82c-137">En esta sección, implementará la función SetSubscription.</span><span class="sxs-lookup"><span data-stu-id="dc82c-137">In this section, you'll implement the SetSubscription function.</span></span> <span data-ttu-id="dc82c-138">Esta función actuará como una API a la que llama la aplicación de prueba para crear o eliminar una suscripción en la bandeja de entrada de un usuario.</span><span class="sxs-lookup"><span data-stu-id="dc82c-138">This function will act as an API that is called by the test application to create or delete a subscription on a user's inbox.</span></span>

1. <span data-ttu-id="dc82c-139">Cree un nuevo archivo en el directorio **modelos** denominado **SetSubscriptionPayload.CS** y agregue el siguiente código.</span><span class="sxs-lookup"><span data-stu-id="dc82c-139">Create a new file in the **Models** directory named **SetSubscriptionPayload.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Models/SetSubscriptionPayload.cs" id="SetSubscriptionPayloadSnippet":::

1. <span data-ttu-id="dc82c-140">Abra **./GraphTutorial/SetSubscription.CS** y reemplace todo el contenido por lo siguiente.</span><span class="sxs-lookup"><span data-stu-id="dc82c-140">Open **./GraphTutorial/SetSubscription.cs** and replace its entire contents with the following.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/SetSubscription.cs" id="SetSubscriptionSnippet":::

<span data-ttu-id="dc82c-141">Tómese un momento para considerar lo que hace el código en **SetSubscription.CS** .</span><span class="sxs-lookup"><span data-stu-id="dc82c-141">Take a moment to consider what the code in **SetSubscription.cs** does.</span></span>

- <span data-ttu-id="dc82c-142">La `Run` función lee la carga útil JSON enviada en la solicitud post para determinar el tipo de solicitud (subscribe o unsubscribe), el identificador de usuario para suscribirse y el identificador de suscripción para cancelar la suscripción.</span><span class="sxs-lookup"><span data-stu-id="dc82c-142">The `Run` function reads the JSON payload sent in the POST request to determine the request type (subscribe or unsubscribe), the user ID to subscribe for, and the subscription ID to unsubscribe.</span></span>
- <span data-ttu-id="dc82c-143">Si la solicitud es una solicitud subscribe, usa el SDK de Microsoft Graph para crear una nueva suscripción en la bandeja de entrada del usuario especificado.</span><span class="sxs-lookup"><span data-stu-id="dc82c-143">If the request is a subscribe request, it uses the Microsoft Graph SDK to create a new subscription in the specified user's inbox.</span></span> <span data-ttu-id="dc82c-144">La suscripción recibirá una notificación cuando se creen o actualicen los mensajes.</span><span class="sxs-lookup"><span data-stu-id="dc82c-144">The subscription will notify when messages are created or updated.</span></span> <span data-ttu-id="dc82c-145">La nueva suscripción se devuelve en la carga JSON de la respuesta.</span><span class="sxs-lookup"><span data-stu-id="dc82c-145">The new subscription is returned in the JSON payload of the response.</span></span>
- <span data-ttu-id="dc82c-146">Si la solicitud es una solicitud de cancelación de suscripción, usa el SDK de Microsoft Graph para eliminar la suscripción especificada.</span><span class="sxs-lookup"><span data-stu-id="dc82c-146">If the request is an unsubscribe request, it uses the Microsoft Graph SDK to delete the specified subscription.</span></span>

## <a name="call-setsubscription-from-the-test-app"></a><span data-ttu-id="dc82c-147">Llamar a SetSubscription desde la aplicación de prueba</span><span class="sxs-lookup"><span data-stu-id="dc82c-147">Call SetSubscription from the test app</span></span>

<span data-ttu-id="dc82c-148">En esta sección, implementará funciones para crear y eliminar suscripciones en la aplicación de prueba.</span><span class="sxs-lookup"><span data-stu-id="dc82c-148">In this section, you'll implement functions to create and delete subscriptions in the test app.</span></span>

1. <span data-ttu-id="dc82c-149">Abra el **azurefunctions.js./TestClient/** y agregue la siguiente función.</span><span class="sxs-lookup"><span data-stu-id="dc82c-149">Open **./TestClient/azurefunctions.js** and add the following function.</span></span>

    :::code language="javascript" source="../demo/TestClient/azurefunctions.js" id="createSubscriptionSnippet":::

    <span data-ttu-id="dc82c-150">Este código llama a la `SetSubscription` función Azure para suscribirse y agrega la nueva suscripción a la matriz de suscripciones de la sesión.</span><span class="sxs-lookup"><span data-stu-id="dc82c-150">This code calls the `SetSubscription` Azure Function to subscribe and adds the new subscription to the array of subscriptions in the session.</span></span>

1. <span data-ttu-id="dc82c-151">Agregue la siguiente función a **azurefunctions.js**.</span><span class="sxs-lookup"><span data-stu-id="dc82c-151">Add the following function to **azurefunctions.js**.</span></span>

    :::code language="javascript" source="../demo/TestClient/azurefunctions.js" id="deleteSubscriptionSnippet":::

    <span data-ttu-id="dc82c-152">Este código llama `SetSubscription` a la función de Azure para anular y quitar la suscripción de la matriz de suscripciones de la sesión.</span><span class="sxs-lookup"><span data-stu-id="dc82c-152">This code calls the `SetSubscription` Azure Function to un and removes the subscription from the array of subscriptions in the session.</span></span>

1. <span data-ttu-id="dc82c-153">Si no se está ejecutando ngrok, ejecute ngrok ( `ngrok http 7071` ) y copie la dirección URL de reenvío https.</span><span class="sxs-lookup"><span data-stu-id="dc82c-153">If you do not have ngrok running, run ngrok (`ngrok http 7071`) and copy the HTTPS forwarding URL.</span></span>

1. <span data-ttu-id="dc82c-154">Para agregar la dirección URL ngrok al almacén de secretos de usuario, ejecute el siguiente comando.</span><span class="sxs-lookup"><span data-stu-id="dc82c-154">Add the ngrok URL to the user secrets store by running the following command.</span></span>

    ```Shell
    dotnet user-secrets set ngrokUrl "YOUR_NGROK_URL_HERE"
    ```

    > [!IMPORTANT]
    > <span data-ttu-id="dc82c-155">Si reinicia ngrok, tendrá que repetir este comando para actualizar la dirección URL de ngrok.</span><span class="sxs-lookup"><span data-stu-id="dc82c-155">If you restart ngrok, you will need to repeat this command to update your ngrok URL.</span></span>

1. <span data-ttu-id="dc82c-156">Cambie el directorio actual de la CLI al directorio **./GraphTutorial** y ejecute el siguiente comando para iniciar la función de Azure de forma local.</span><span class="sxs-lookup"><span data-stu-id="dc82c-156">Change the current directory in your CLI to the **./GraphTutorial** directory and run the following command to start the Azure Function locally.</span></span>

    ```Shell
    func start
    ```

1. <span data-ttu-id="dc82c-157">Actualice el SPA y seleccione el elemento **suscripciones** NAV.</span><span class="sxs-lookup"><span data-stu-id="dc82c-157">Refresh the SPA and select the **Subscriptions** nav item.</span></span> <span data-ttu-id="dc82c-158">Escriba un identificador de usuario para un usuario de la organización de Microsoft 365 que tenga un buzón de correo de Exchange Online.</span><span class="sxs-lookup"><span data-stu-id="dc82c-158">Enter a user ID for a user in your Microsoft 365 organization that has an Exchange Online mailbox.</span></span> <span data-ttu-id="dc82c-159">Puede ser el del usuario `id` (de Microsoft Graph) o el del usuario `userPrincipalName` .</span><span class="sxs-lookup"><span data-stu-id="dc82c-159">This can either be the user's `id` (from Microsoft Graph) or the user's `userPrincipalName`.</span></span> <span data-ttu-id="dc82c-160">Haga clic en **suscribirse**.</span><span class="sxs-lookup"><span data-stu-id="dc82c-160">Click **Subscribe**.</span></span>

1. <span data-ttu-id="dc82c-161">La página se actualizará y mostrará la nueva suscripción en la tabla.</span><span class="sxs-lookup"><span data-stu-id="dc82c-161">The page refreshes showing the new subscription in the table.</span></span>

1. <span data-ttu-id="dc82c-162">Enviar un correo electrónico al usuario.</span><span class="sxs-lookup"><span data-stu-id="dc82c-162">Send an email to the user.</span></span> <span data-ttu-id="dc82c-163">Después de un breve período de tiempo, `Notify` se debe llamar a la función.</span><span class="sxs-lookup"><span data-stu-id="dc82c-163">After a brief time, the `Notify` function should be called.</span></span> <span data-ttu-id="dc82c-164">Puede comprobarlo en la interfaz Web de ngrok ( `http://localhost:4040` ) o en el resultado de la depuración del proyecto de la función de Azure.</span><span class="sxs-lookup"><span data-stu-id="dc82c-164">You can verify this in the ngrok web interface (`http://localhost:4040`) or in the debug output of the Azure Function project.</span></span>

    ```Shell
    ...
    [7/8/2020 7:33:57 PM] The following message was created:
    [7/8/2020 7:33:57 PM] Subject: Hi Megan!, ID: AAMkAGUyN2I4N2RlLTEzMTAtNDBmYy1hODdlLTY2NTQwODE2MGEwZgBGAAAAAAA2J9QH-DvMRK3pBt_8rA6nBwCuPIFjbMEkToHcVnQirM5qAAAAAAEMAACuPIFjbMEkToHcVnQirM5qAACHmpAsAAA=
    [7/8/2020 7:33:57 PM] Executed 'Notify' (Succeeded, Id=9c40af0b-e082-4418-aa3a-aee624f30e7a)
    ...
    ```

1. <span data-ttu-id="dc82c-165">En la aplicación de prueba, haga clic en **eliminar** en la fila de la tabla de la suscripción.</span><span class="sxs-lookup"><span data-stu-id="dc82c-165">In the test app, click **Delete** in the table row for the subscription.</span></span> <span data-ttu-id="dc82c-166">La página se actualiza y la suscripción ya no está en la tabla.</span><span class="sxs-lookup"><span data-stu-id="dc82c-166">The page refreshes and the subscription is no longer in the table.</span></span>
